<?xml version="1.0" encoding="utf-8" ?>
<ContentPage
    x:Class="CityTour.StoryCanvasPage"
    xmlns="http://schemas.microsoft.com/dotnet/2021/maui"
    xmlns:x="http://schemas.microsoft.com/winfx/2009/xaml"
    xmlns:models="clr-namespace:CityTour.Models"
    Padding="16">

    <Grid RowSpacing="12">
        <Grid.RowDefinitions>
            <RowDefinition Height="Auto" />
            <RowDefinition Height="Auto" />
            <RowDefinition Height="Auto" />
            <RowDefinition Height="Auto" />
            <RowDefinition Height="Auto" />
            <RowDefinition Height="Auto" />
            <RowDefinition Height="Auto" />
            <RowDefinition Height="Auto" />
            <RowDefinition Height="*" />
            <RowDefinition Height="Auto" />
            <RowDefinition Height="Auto" />
            <RowDefinition Height="Auto" />
            <RowDefinition Height="*" />
            <RowDefinition Height="Auto" />
            <RowDefinition Height="Auto" />
            <RowDefinition Height="Auto" />
            <RowDefinition Height="Auto" />
            <RowDefinition Height="Auto" />
        </Grid.RowDefinitions>

        <Grid Grid.Row="0"
              ColumnDefinitions="*,Auto"
              ColumnSpacing="8"
              VerticalOptions="Center">
            <Label Text="New story"
                   FontSize="22"
                   FontAttributes="Bold" />
            <Button x:Name="PromptInfoButton"
                    Grid.Column="1"
                    Text="Story prompt"
                    FontSize="12"
                    Padding="12,6"
                    Clicked="OnPromptInfoClicked"
                    SemanticProperties.Description="Show the AI prompt that was used to generate this story."
                    IsEnabled="False" />
        </Grid>

        <Label x:Name="PromptLabel"
               Grid.Row="1"
               FontSize="13"
               LineBreakMode="WordWrap"
               Margin="0,4,0,0"
               TextColor="{AppThemeBinding Light=#444, Dark=#DDD}"
               IsVisible="False" />

        <Label x:Name="BuildingNameLabel"
               Grid.Row="2"
               FontSize="14"
               LineBreakMode="WordWrap"
               TextColor="{AppThemeBinding Light=#666, Dark=#AAA}" />

        <StackLayout Grid.Row="3"
                     Spacing="4">
            <Label Text="Story focus"
                   FontAttributes="Bold"
                   FontSize="14" />
            <Picker x:Name="CategoryPicker"
                    Title="Choose a category"
                    SelectedIndexChanged="OnCategoryChanged" />
        </StackLayout>

        <StackLayout Grid.Row="4"
                     Spacing="4"
                     IsVisible="False">
            <Label Text="AI model"
                   FontAttributes="Bold"
                   FontSize="14" />
            <Picker x:Name="ModelPicker"
                    Title="Choose a model"
                    ItemDisplayBinding="{Binding DisplayName}"
                    SelectedIndexChanged="OnModelChanged" />
        </StackLayout>

        <StackLayout Grid.Row="5"
                     Spacing="4"
                     IsVisible="False">
            <Label Text="Max AI response tokens"
                   FontAttributes="Bold"
                   FontSize="14" />
            <Entry x:Name="MaxTokensEntry"
                   Keyboard="Numeric"
                   MaxLength="5"
                   Placeholder="e.g. 900"
                   ReturnType="Done"
                   TextChanged="OnMaxTokensEntryTextChanged"
                   Completed="OnMaxTokensEntryCompleted"
                   Unfocused="OnMaxTokensEntryUnfocused"
                   SemanticProperties.Description="Set the maximum number of tokens the AI may use when answering." />
            <Label x:Name="MaxTokensInfoLabel"
                   FontSize="12"
                   LineBreakMode="WordWrap"
                   TextColor="{AppThemeBinding Light=#555, Dark=#CCC}" />
            <Label x:Name="MaxTokensErrorLabel"
                   FontSize="12"
                   LineBreakMode="WordWrap"
                   TextColor="{AppThemeBinding Light=#DC2626, Dark=#FCA5A5}"
                   IsVisible="False" />
        </StackLayout>

        <Grid Grid.Row="6"
              ColumnDefinitions="Auto,*"
              ColumnSpacing="8">
            <ActivityIndicator x:Name="LoadingIndicator"
                                VerticalOptions="Center"
                                IsVisible="False"
                                IsRunning="False" />
            <Label x:Name="StatusLabel"
                   VerticalOptions="Center"
                   LineBreakMode="WordWrap"
                   TextColor="{AppThemeBinding Light=#555, Dark=#CCC}" />
        </Grid>

        <Button x:Name="ShowParseResponseButton"
                Grid.Row="7"
                Text="Show OpenAI response"
                SemanticProperties.Description="Show the raw response returned by OpenAI when parsing fails."
                Clicked="OnShowParseResponseClicked"
                IsVisible="False" />

        <Editor x:Name="StoryEditor"
                Grid.Row="8"
                Placeholder="Tweak or add your own notes here..."
                AutoSize="TextChanges" />

        <Button x:Name="WikipediaButton"
                Grid.Row="9"
                Text="Fetch Wikipedia summary"
                Clicked="OnFetchWikipediaClicked"
                IsVisible="False" />

        <Label Grid.Row="10"
               Text="Ask about this place"
               FontSize="14"
               FontAttributes="Bold" />

        <Grid Grid.Row="11"
              ColumnDefinitions="Auto,*"
              ColumnSpacing="8">
            <ActivityIndicator x:Name="ChatLoadingIndicator"
                                VerticalOptions="Center"
                                IsVisible="False"
                                IsRunning="False" />
            <Label x:Name="ChatStatusLabel"
                   VerticalOptions="Center"
                   LineBreakMode="WordWrap"
                   TextColor="{AppThemeBinding Light=#555, Dark=#CCC}"
                   Text="Ask the guide for more details about this address." />
        </Grid>

        <CollectionView x:Name="ChatCollectionView"
                        Grid.Row="12"
                        BackgroundColor="Transparent"
                        SelectionMode="None"
                        VerticalScrollBarVisibility="Never">
            <CollectionView.ItemsLayout>
                <LinearItemsLayout Orientation="Vertical" />
            </CollectionView.ItemsLayout>
            <CollectionView.ItemTemplate>
                <DataTemplate x:DataType="models:ChatMessage">
                    <Frame Margin="0,4"
                           Padding="12"
                           CornerRadius="12"
                           HasShadow="False"
                           BackgroundColor="{AppThemeBinding Light=#F4F4F5, Dark=#27272A}"
                           MaximumWidthRequest="420">
                        <Frame.Triggers>
                            <DataTrigger TargetType="Frame"
                                         Binding="{Binding IsUser}"
                                         Value="True">
                                <Setter Property="HorizontalOptions" Value="End" />
                                <Setter Property="BackgroundColor" Value="{AppThemeBinding Light=#D1E8FF, Dark=#1F3A5F}" />
                                <Setter Property="Margin" Value="48,4,0,4" />
                            </DataTrigger>
                            <DataTrigger TargetType="Frame"
                                         Binding="{Binding IsUser}"
                                         Value="False">
                                <Setter Property="HorizontalOptions" Value="Start" />
                                <Setter Property="BackgroundColor" Value="{AppThemeBinding Light=#F4F4F5, Dark=#27272A}" />
                                <Setter Property="Margin" Value="0,4,48,4" />
                            </DataTrigger>
                        </Frame.Triggers>
                        <Label Text="{Binding Message}"
                               LineBreakMode="WordWrap"
                               TextColor="{AppThemeBinding Light=#111, Dark=#EEE}" />
                    </Frame>
                </DataTemplate>
            </CollectionView.ItemTemplate>
        </CollectionView>

        <Grid Grid.Row="13"
              ColumnDefinitions="*,Auto"
              ColumnSpacing="8">
            <Entry x:Name="ChatEntry"
                   Placeholder="Ask a follow-up question about this address..."
                   Completed="OnChatEntryCompleted"
                   TextChanged="OnChatTextChanged" />
            <Button x:Name="SendChatButton"
                    Grid.Column="1"
                    Text="Send"
                    IsEnabled="False"
                    Clicked="OnSendChatClicked" />
        </Grid>

        <StackLayout Grid.Row="14"
                     Spacing="4">
            <Label Text="Voice"
                   FontAttributes="Bold"
                   FontSize="14" />
            <Picker x:Name="VoicePicker"
                    Title="Choose a voice"
                    ItemDisplayBinding="{Binding DisplayName}" />
        </StackLayout>

        <Grid Grid.Row="15"
              ColumnDefinitions="*,*"
              ColumnSpacing="8">
            <Button x:Name="ListenButton"
                    Text="Listen"
                    Clicked="OnListenClicked" />
            <Button x:Name="StopButton"
                    Grid.Column="1"
                    Text="Stop"
                    IsEnabled="False"
                    Clicked="OnStopClicked" />
        </Grid>

        <Button x:Name="RegenerateButton"
                Grid.Row="16"
                Text="Regenerate story"
                Clicked="OnRegenerateClicked" />

        <Button Grid.Row="17"
                Text="Close"
                Clicked="OnCloseClicked" />
    </Grid>
</ContentPage>
